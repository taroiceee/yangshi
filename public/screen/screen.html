<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ•°æ®å¯è§†åŒ–å¤§å±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts-wordcloud/2.1.0/echarts-wordcloud.min.js"></script>
    <script>
        if (typeof echarts === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"><\/script>');
        }
    </script>
    <link rel="stylesheet" href="css/screen.css">
    <script src="base.js"></script>
</head>
<body>
<!-- å›¾ä¾‹åŒº -->
<div class="gallery-section">
    <div class="gallery-title">ä¹’ä¹“èµ›äº‹</div>
    <div class="gallery-list" id="galleryList">
        <!-- å›¾ä¾‹å†…å®¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
    <!-- æ•°æ®æ€»è§ˆå¡ç‰‡åŒº -->
    <div class="overview">
        <div class="overview-card">
            <div class="icon">ğŸ‘¤</div>
            <div class="info">
                <div class="title">ç”¨æˆ·æ€»æ•°</div>
            <div class="value" id="userCount">-</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="icon">ğŸœ</div>
            <div class="info">
                <div class="title">ç¾é£Ÿä¿¡æ¯æ€»æ•°</div>
            <div class="value" id="foodSum">-</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="icon">ğŸ›ï¸</div>
            <div class="info">
                <div class="title">è¯„åˆ†é¢„æµ‹æ€»æ•°</div>
            <div class="value" id="predictCount">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="chart-container table-container">
            <h2>æ•°æ®åˆ—è¡¨</h2>
            <table class="data-table">
                <thead>
                    <tr>
                <th>å•†å“ç¼–å·</th>
                <th>å•†å“åç§°</th>
                <th>åˆ†ç±»åç§°</th>
                <th>å°é¢</th>
                <th>å®šåˆ¶åº“å­˜</th>
                <th>ç”Ÿäº§æ—¥æœŸ</th>
                <th>å•†å“ç›¸å†Œ</th>
                <th>å•†å®¶ç”¨æˆ·</th>
                <th>ä¿è´¨æ—¶é—´</th>
                <th>å®šåˆ¶å£°æ˜</th>
                <th>å®šåˆ¶ç±»å‹</th>
                <th>å®šåˆ¶ä»·æ ¼</th>
                <th>åˆ†ç±»ç¼–å·</th>
                    </tr>
                </thead>
            <tbody id="dataTableBody">
            <!-- JS åŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
        </div>

        <!-- è¯äº‘å›¾ -->
        <div class="chart-container">
            <h2>è¯äº‘å›¾</h2>
            <div id="wordCloudChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- ç¯å½¢å›¾ï¼ˆJSç»„ä»¶è°ƒç”¨ç¤ºä¾‹ï¼‰ -->
        <div class="chart-container">
        <h2>ç¯å½¢å›¾</h2>
            <div id="pieChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- å—ä¸æ ¼å°”ç«ç‘°å›¾ -->
        <div class="chart-container">
            <h2>å—ä¸æ ¼å°”ç«ç‘°å›¾</h2>
            <div id="roseChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- æŸ±çŠ¶å›¾ -->
        <div class="chart-container">
            <h2>æŸ±çŠ¶å›¾</h2>
            <div id="barChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- å †å æ¡å½¢å›¾ -->
        <div class="chart-container">
            <h2>å †å æ¡å½¢å›¾</h2>
            <div id="stackedBarChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- åŠ¨æ€æ’åºæŠ˜çº¿å›¾ -->
        <div class="chart-container">
            <h2>åŠ¨æ€æ’åºæŠ˜çº¿å›¾</h2>
            <div id="dynamicLineChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- å †å é¢ç§¯å›¾ -->
        <div class="chart-container">
            <h2>å †å é¢ç§¯å›¾</h2>
            <div id="stackedAreaChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- æŠ˜æŸ±æ··åˆå›¾ -->
        <div class="chart-container">
            <h2>æŠ˜æŸ±æ··åˆå›¾</h2>
            <div id="mixedChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- é›·è¾¾å›¾ -->
        <div class="chart-container">
            <h2>é›·è¾¾å›¾</h2>
            <div id="radarChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- çƒ­åŠ›å›¾ -->
        <div class="chart-container">
            <h2>çƒ­åŠ›å›¾</h2>
            <div id="heatmapChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- æ•£ç‚¹å›¾ -->
        <div class="chart-container">
            <h2>æ•£ç‚¹å›¾</h2>
            <div id="scatterChart" style="width: 100%; height: 350px;"></div>
        </div>

        <!-- æ¼æ–—å›¾ -->
        <div class="chart-container">
            <h2>æ¼æ–—å›¾</h2>
            <div id="funnelChart" style="width: 100%; height: 350px;"></div>
        </div>
    </div>

<script src="./js/dynamicLineOption.js"></script>
<script src="./js/stackedBarOption.js"></script>
<script src="./js/pieOption.js"></script>
<script src="./js/roseOption.js"></script>
<script src="./js/barOption.js"></script>
<script src="./js/mixedOption.js"></script>
<script src="./js/radarOption.js"></script>
<script src="./js/heatmapOption.js"></script>
<script src="./js/scatterOption.js"></script>
<script src="./js/funnelOption.js"></script>
<script src="./js/wordcloudOption.js"></script>
<script src="./js/stackedAreaOption.js"></script>
<script src="./css/colors/barColors.js"></script>
<script src="./css/colors/funnelColors.js"></script>
<script src="./css/colors/heatmapColors.js"></script>
<script src="./css/colors/mixedColors.js"></script>
<script src="./css/colors/pieColors.js"></script>
<script src="./css/colors/radarColors.js"></script>
<script src="./css/colors/roseColors.js"></script>
<script src="./css/colors/scatterColors.js"></script>
<script src="./css/colors/stackedAreaColors.js"></script>
<script src="./css/colors/wordcloudColors.js"></script>
<script src="./css/colors/dynamicLineColors.js"></script>
<script src="./css/colors/stackedBarColors.js"></script>
    <script>
        // ç¯å½¢å›¾
        var pieChart = echarts.init(document.getElementById('pieChart'));

    function updatePieChart() {
        fetch(baseUrl + '/api/goods/list_group?groupby=type')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    // è§£ææ¥å£æ•°æ®
                    var list = data.result.list;
                    var pieLabels = list.map(item => item.type || item[1]);
                    var pieData1 = list.map(item => item.count || item[0]);
                    pieChart.setOption(getPieOption(pieData1, pieLabels));
                }
            })
            .catch(err => {
                console.error('è·å–ç¯å½¢å›¾æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updatePieChart();
    });

        // å—ä¸æ ¼å°”ç«ç‘°å›¾
        var roseChart = echarts.init(document.getElementById('roseChart'));

    function updateRoseChart() {
        fetch(baseUrl + '/api/registered_users/list_group?groupby=gender')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    // è§£ææ¥å£æ•°æ®
                    var list = data.result.list;
                    var roseLabels = list.map(item => item.gender || item[1]);
                    var roseData = list.map(item => item.count || item[0]);
                    roseChart.setOption(getRoseOption(roseData, roseLabels));
                }
            })
            .catch(err => {
                console.error('è·å–å—ä¸æ ¼å°”ç«ç‘°å›¾æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateRoseChart();
    });

        // æŸ±çŠ¶å›¾
        var barChart = echarts.init(document.getElementById('barChart'));

    function updateBarChart() {
        fetch(baseUrl + '/api/merchant_users/bar_group?field=registered_capital,number_of_employees&groupby=merchant_name')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    // è§£ææ¥å£æ•°æ®
                    var list = data.result.list;
                    var barLabels = list.map(item => item[0]);
                    var seriesNames = ['æ³¨å†Œèµ„æœ¬', 'å‘˜å·¥æ•°'];
                    barChart.setOption(getBarOption(list, barLabels, seriesNames));
                }
            })
            .catch(err => {
                console.error('è·å–æŸ±çŠ¶å›¾æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateBarChart();
    });

        // å †å æ¡å½¢å›¾
        var stackedBarChart = echarts.init(document.getElementById('stackedBarChart'));

    function updateStackedBarChart() {
        fetch(baseUrl + '/api/customized_products/bar_group?field=customized_inventory,customized_pricing&groupby=classification_name')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    var list = data.result.list;
                    var stackedBarLabels = list.map(item => item[0]);
                    var seriesNames = ['å®šåˆ¶åº“å­˜', 'å®šåˆ¶ä»·æ ¼'];
                    stackedBarChart.setOption(getStackedBarOption(list, stackedBarLabels, seriesNames));
                }
            })
            .catch(err => {
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateStackedBarChart();
    });

        // åŠ¨æ€æ’åºæŠ˜çº¿å›¾
        var dynamicLineChart = echarts.init(document.getElementById('dynamicLineChart'));

    function updateDynamicLineChart() {
        // è·å–å•†å“åç§°åˆ—è¡¨
        fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=product_name')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    const names = data.result.list.map(item => item.product_name);
                    // è·å–äº¤ä»˜æ—¥æœŸåˆ—è¡¨
                    fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=delivery_date')
                        .then(res => res.json())
                        .then(dateData => {
                            if (dateData.result && dateData.result.list) {
                                const xAxis = dateData.result.list.map(item => item.delivery_date);
                                // æ„å»ºæ•°æ®æ•°ç»„
                                const dynamicData = [];
                                names.forEach(name => {
                                    xAxis.forEach(deliveryDate => {
                                        // è·å–æ¯ä¸ªå•†å“åœ¨æ¯ä¸ªæ—¥æœŸçš„æ€»ä»·æ ¼
                                        fetch(`${baseUrl}/api/i_want_to_customize/sum?field=total_price&product_name=${encodeURIComponent(name)}&delivery_date=${encodeURIComponent(deliveryDate)}`)
                                            .then(res => res.json())
                                            .then(priceData => {
                                                const totalPrice = priceData.result || 0;
                                                dynamicData.push([
                                                    deliveryDate,
                                                    totalPrice,
                                                    name
                                                ]);

                                                // å½“æ‰€æœ‰æ•°æ®éƒ½è·å–å®Œæˆåï¼Œæ›´æ–°å›¾è¡¨
                                                if (dynamicData.length === names.length * xAxis.length) {
                                                    dynamicLineChart.setOption(getDynamicLineOption(names, xAxis, dynamicData));
                                                }
                                            })
                                            .catch(err => {
                                                console.error('è·å–ä»·æ ¼æ•°æ®å¤±è´¥:', err);
                                            });
                                    });
                                });
                            }
                        })
                        .catch(err => {
                            console.error('è·å–äº¤ä»˜æ—¥æœŸæ•°æ®å¤±è´¥:', err);
                        });
                }
            })
            .catch(err => {
                console.error('è·å–å•†å“åç§°æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateDynamicLineChart();
    });

        // å †å é¢ç§¯å›¾
        var stackedAreaChart = echarts.init(document.getElementById('stackedAreaChart'));

    function updateStackedAreaChart() {
        // è·å–å•†å“åç§°åˆ—è¡¨
        fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=product_name')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    const names = data.result.list.map(item => item.product_name);

                    // è·å–äº¤ä»˜æ—¥æœŸåˆ—è¡¨
                    fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=delivery_date')
                        .then(res => res.json())
                        .then(dateData => {
                            if (dateData.result && dateData.result.list) {
                                const xAxis = dateData.result.list.map(item => item.delivery_date);

                                // æ„å»ºæ•°æ®æ•°ç»„
                                const stackedAreaData = [];
                                names.forEach(name => {
                                    xAxis.forEach(deliveryDate => {
                                        // è·å–æ¯ä¸ªå•†å“åœ¨æ¯ä¸ªæ—¥æœŸçš„æ€»ä»·æ ¼
                                        fetch(`${baseUrl}/api/i_want_to_customize/sum?field=total_price&product_name=${encodeURIComponent(name)}&delivery_date=${encodeURIComponent(deliveryDate)}`)
                                            .then(res => res.json())
                                            .then(priceData => {
                                                const totalPrice = priceData.result || 0;
                                                stackedAreaData.push([
                                                    deliveryDate,
                                                    totalPrice,
                                                    name
                                                ]);

                                                // å½“æ‰€æœ‰æ•°æ®éƒ½è·å–å®Œæˆåï¼Œæ›´æ–°å›¾è¡¨
                                                if (stackedAreaData.length === names.length * xAxis.length) {
                                                    stackedAreaChart.setOption(getStackedAreaOption(names, xAxis, stackedAreaData));
                                                }
                                            })
                                            .catch(err => {
                                                console.error('è·å–ä»·æ ¼æ•°æ®å¤±è´¥:', err);
                                            });
                                    });
                                });
                            }
                        })
                        .catch(err => {
                            console.error('è·å–äº¤ä»˜æ—¥æœŸæ•°æ®å¤±è´¥:', err);
                        });
                }
            })
            .catch(err => {
                console.error('è·å–å•†å“åç§°æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateStackedAreaChart();
    });

        // æŠ˜æŸ±æ··åˆå›¾
        var mixedChart = echarts.init(document.getElementById('mixedChart'));

    function updateMixedChart() {
        // è¯·æ±‚ baseUrl + '/api/i_want_to_customize/get_list?groupby=delivery_date' æ¥å£ï¼Œè§£æè¿”å›çš„ list æ•°æ®ï¼Œæå– delivery_date å­—æ®µä½œä¸º mixedLabels
        fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=delivery_date')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    var mixedLabels = data.result.list.map(item => item.delivery_date);
                    // è¯·æ±‚ bar_group æ¥å£ï¼Œè§£æè¿”å›çš„ list æ•°æ®ï¼Œæå–è´­ä¹°æ•°é‡ã€å®šåˆ¶ä»·æ ¼ç­‰ä½œä¸º datas æ•°ç»„ï¼ˆæŸ±çŠ¶éƒ¨åˆ†ï¼‰ï¼Œå¹¶åŠ¨æ€ç”Ÿæˆ legendDataï¼ˆæŸ±1ã€æŸ±2ã€â€¦ã€çº¿ï¼‰
                    fetch(baseUrl + '/api/i_want_to_customize/bar_group?field=purchase_quantity,customized_pricing&groupby=delivery_date')
                        .then(res => res.json())
                        .then(barData => {
                            if (barData.result && barData.result.list) {
                                let datas = [];
                                let legendData = ['æŸ±1','æŸ±2'];
                                for (let i = 0; i < legendData.length; i++) {
                                    let data = [];
                                    barData.result.list.forEach((item, j) => {
                                        data.push(item[i+1]);
                                    });
                                    datas.push({ type: 'bar', data: data }); // ä»ç¬¬äºŒä¸ªå€¼å¼€å§‹ï¼Œä½œä¸ºæŸ±çŠ¶æ•°æ®
                                }

                                // å¾ªç¯ mixedLabelsï¼Œè¯·æ±‚ sum æ¥å£ï¼Œå°†è¿”å›çš„ result å€¼ä½œä¸º mixedLine æ•°ç»„ï¼Œå¹¶æ„å»º datas æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆ{ type: 'line', data: mixedLine }ï¼‰
                                var mixedLine = [];
                                var promises = mixedLabels.map(date => fetch(baseUrl + '/api/i_want_to_customize/sum?field=total_price&delivery_date=' + encodeURIComponent(date)).then(res => res.json()).then(sumData => mixedLine.push(sumData.result)));
                                Promise.all(promises).then(() => {
                                    datas.push({ type: 'line', data: mixedLine });
                                    legendData.push('çº¿'); // åŠ¨æ€ç”Ÿæˆ legendDataï¼ˆæŸ±1ã€æŸ±2ã€â€¦ã€çº¿ï¼‰
                                    mixedChart.setOption(getMixedOption(mixedLabels, legendData, datas));
                                });
                            }
                        })
                        .catch(err => { console.error('è·å– bar_group æ•°æ®å¤±è´¥:', err); });
                }
            })
            .catch(err => { console.error('è·å– mixedLabels æ•°æ®å¤±è´¥:', err); });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateMixedChart();
    });

        // é›·è¾¾å›¾
    var radarChart = echarts.init(document.getElementById('radarChart'));

    function updateRadarChart() {
        // å®šä¹‰è¯„åˆ†ç³»åˆ—
        const radarSeries = [
            {name: 'appearance_rating', title: 'å¤–è§‚è¯„åˆ†', type: 'æ•°å­—'},
            {name: 'performance_score', title: 'æ€§èƒ½è¯„åˆ†', type: 'æ•°å­—'},
            {name: 'quality_score', title: 'è´¨é‡è¯„åˆ†', type: 'æ•°å­—'},
            {name: 'use_experience', title: 'ä½¿ç”¨ä½“éªŒ', type: 'æ•°å­—'},
            {name: 'cost_effective', title: 'æ€§ä»·æ¯”', type: 'æ•°å­—'},
            {name: 'after_sales_score', title: 'å”®åè¯„åˆ†', type: 'æ•°å­—'}
        ];

        // è·å–åˆ†ç±»åç§°åˆ—è¡¨
        fetch(baseUrl + '/api/commodity_rating/list_group?groupby=category_name')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    const categories = data.result.list.map(item => item.category_name);

                    // æ„å»ºé›·è¾¾å›¾æ•°æ®
                    const radarData = [];
                    const maxValues = {};

                    // åˆå§‹åŒ–æœ€å¤§å€¼å¯¹è±¡
                    radarSeries.forEach(series => {
                        maxValues[series.name] = 0;
                    });

                    // è·å–æ¯ä¸ªåˆ†ç±»çš„è¯„åˆ†æ•°æ®
                    const fetchPromises = categories.map(category => {
                        const categoryData = [];
                        const seriesPromises = radarSeries.map(series => {
                            return fetch(`${baseUrl}/api/commodity_rating/sum?field=${series.name}&category_name=${encodeURIComponent(category)}`)
                                .then(res => res.json())
                                .then(scoreData => {
                                    const score = scoreData.result || 0;
                                    categoryData.push(score);
                                    // æ›´æ–°æœ€å¤§å€¼
                                    maxValues[series.name] = Math.max(maxValues[series.name], score);
                                    return score;
                                })
                                .catch(err => {
                                    console.error(`è·å–${category}çš„${series.title}æ•°æ®å¤±è´¥:`, err);
                                    return 0;
                                });
                        });

                        return Promise.all(seriesPromises).then(() => {
                            radarData.push(categoryData);
                        });
                    });

                    // æ‰€æœ‰æ•°æ®è·å–å®Œæˆåæ›´æ–°å›¾è¡¨
                    Promise.all(fetchPromises).then(() => {
                        // æ„å»ºé›·è¾¾å›¾æŒ‡æ ‡
                        const radarIndicators = radarSeries.map(series => ({
                            name: series.title,
                            max: maxValues[series.name] || 1 // ç¡®ä¿æœ€å¤§å€¼è‡³å°‘ä¸º1
                        }));

                        // æ„å»ºç³»åˆ—åç§°
                        const seriesNames = categories;

                        radarChart.setOption(getRadarOption(radarData, seriesNames, radarIndicators));
                    });
                }
            })
            .catch(err => {
                console.error('è·å–åˆ†ç±»æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateRadarChart();
    });

        // çƒ­åŠ›å›¾
    var heatmapChart = echarts.init(document.getElementById('heatmapChart'));

    function updateHeatmapChart() {
        // è·å–å•†å“åç§°åˆ—è¡¨
        fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=product_name')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    const names = data.result.list.map(item => item.product_name);

                    // è·å–äº¤ä»˜æ—¥æœŸåˆ—è¡¨
                    fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=delivery_date')
                        .then(res => res.json())
                        .then(dateData => {
                            if (dateData.result && dateData.result.list) {
                                const xAxis = dateData.result.list.map(item => item.delivery_date);

                                // æ„å»ºçƒ­åŠ›å›¾æ•°æ®
                                const heatmapData = [];
                                names.forEach((name, nameIndex) => {
                                    xAxis.forEach((deliveryDate, dateIndex) => {
                                        // è·å–æ¯ä¸ªå•†å“åœ¨æ¯ä¸ªæ—¥æœŸçš„æ€»ä»·æ ¼
                                        fetch(`${baseUrl}/api/i_want_to_customize/sum?field=total_price&product_name=${encodeURIComponent(name)}&delivery_date=${encodeURIComponent(deliveryDate)}`)
                                            .then(res => res.json())
                                            .then(priceData => {
                                                const totalPrice = priceData.result || 0;
                                                heatmapData.push([
                                                    dateIndex,
                                                    nameIndex,
                                                    totalPrice
                                                ]);

                                                // å½“æ‰€æœ‰æ•°æ®éƒ½è·å–å®Œæˆåï¼Œæ›´æ–°å›¾è¡¨
                                                if (heatmapData.length === names.length * xAxis.length) {
                                                    heatmapChart.setOption(getHeatmapOption(heatmapData, xAxis, names));
                                                }
                                            })
                                            .catch(err => {
                                                console.error('è·å–ä»·æ ¼æ•°æ®å¤±è´¥:', err);
                                            });
                                    });
                                });
                            }
                        })
                        .catch(err => {
                            console.error('è·å–äº¤ä»˜æ—¥æœŸæ•°æ®å¤±è´¥:', err);
                        });
                }
            })
            .catch(err => {
                console.error('è·å–å•†å“åç§°æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateHeatmapChart();
    });

        // æ•£ç‚¹å›¾
        var scatterChart = echarts.init(document.getElementById('scatterChart'));

    function updateScatterChart() {
        // è·å–å•†å“åç§°åˆ—è¡¨
        fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=product_name')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    const names = data.result.list.map(item => item.product_name);

                    // è·å–äº¤ä»˜æ—¥æœŸåˆ—è¡¨
                    fetch(baseUrl + '/api/i_want_to_customize/get_list?groupby=delivery_date')
                        .then(res => res.json())
                        .then(dateData => {
                            if (dateData.result && dateData.result.list) {
                                const xAxis = dateData.result.list.map(item => item.delivery_date);

                                // æ„å»ºæ•£ç‚¹å›¾æ•°æ®
                                const scatterData = [];
                                names.forEach((name, nameIndex) => {
                                    xAxis.forEach((deliveryDate, dateIndex) => {
                                        // è·å–æ¯ä¸ªå•†å“åœ¨æ¯ä¸ªæ—¥æœŸçš„æ€»ä»·æ ¼
                                        fetch(`${baseUrl}/api/i_want_to_customize/sum?field=total_price&product_name=${encodeURIComponent(name)}&delivery_date=${encodeURIComponent(deliveryDate)}`)
                                            .then(res => res.json())
                                            .then(priceData => {
                                                const totalPrice = priceData.result || 0;
                                                scatterData.push([
                                                    dateIndex,
                                                    totalPrice,
                                                    name
                                                ]);

                                                // å½“æ‰€æœ‰æ•°æ®éƒ½è·å–å®Œæˆåï¼Œæ›´æ–°å›¾è¡¨
                                                if (scatterData.length === names.length * xAxis.length) {
                                                    scatterChart.setOption(getScatterOption(scatterData, xAxis, names, 'æµ‹è¯•'));
                                                }
                                            })
                                            .catch(err => {
                                                console.error('è·å–ä»·æ ¼æ•°æ®å¤±è´¥:', err);
                                            });
                                    });
                                });
                            }
                        })
                        .catch(err => {
                            console.error('è·å–äº¤ä»˜æ—¥æœŸæ•°æ®å¤±è´¥:', err);
                        });
                }
            })
            .catch(err => {
                console.error('è·å–å•†å“åç§°æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateScatterChart();
    });

        // æ¼æ–—å›¾
        var funnelChart = echarts.init(document.getElementById('funnelChart'));

    function updateFunnelChart() {
        fetch(baseUrl + '/api/goods/list_group?groupby=type')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    // è§£ææ¥å£æ•°æ®
                    var list = data.result.list;
                    var funnelLabels = list.map(item => item.type || item[1]);
                    var funnelData = list.map(item => item.count || item[0]);
                    funnelChart.setOption(getFunnelOption(funnelData, funnelLabels,'æµ‹è¯•'));
                }
            })
            .catch(err => {
                console.error('è·å–æ¼æ–—å›¾æ•°æ®å¤±è´¥:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateFunnelChart();
    });

        // è¯äº‘å›¾
        var wordcloudChart = echarts.init(document.getElementById('wordCloudChart'));

    // è·å–åˆ†ç±»æ•°æ®å¹¶æ›´æ–°è¯äº‘å›¾
    function updateWordCloud() {
        fetch(baseUrl + '/api/customized_products/count_group?groupby=classification_name')
            .then(res => res.json())
            .then(data => {
                if (data.result) {
                    // å°†æ¥å£è¿”å›çš„æ•°æ®è½¬æ¢ä¸ºè¯äº‘å›¾æ‰€éœ€æ ¼å¼
                    const wordcloudData = data.result.map(item => ({
                        name: item.classification_name,
                        value: item.count * 1000 // æ”¾å¤§æ•°å€¼ä»¥å¢åŠ è¯äº‘æ•ˆæœ
                    }));

                    // ä½¿ç”¨wordcloudOption.jsä¸­çš„é…ç½®
                    wordcloudChart.setOption(getWordcloudOption(wordcloudData));
                }
            })
            .catch(err => {
                console.error('è·å–åˆ†ç±»æ•°æ®å¤±è´¥:', err);
            });
    }

    // é¡µé¢åŠ è½½æ—¶æ›´æ–°è¯äº‘å›¾
    document.addEventListener('DOMContentLoaded', function () {
        updateWordCloud();
    });

        // çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œé‡ç½®å›¾è¡¨å¤§å°
    window.addEventListener('resize', function () {
            pieChart.resize();
            roseChart.resize();
            barChart.resize();
            stackedBarChart.resize();
            dynamicLineChart.resize();
            stackedAreaChart.resize();
            mixedChart.resize();
            radarChart.resize();
            heatmapChart.resize();
            scatterChart.resize();
            funnelChart.resize();
            wordcloudChart.resize();
        });

    // å›¾ä¾‹åŒºæ•°æ®åŠ¨æ€è·å–ä¸æ¸²æŸ“
    document.addEventListener('DOMContentLoaded', function () {
        fetch(baseUrl + '/api/customized_products/get_list?size=6&page=1')
            .then(res => res.json())
            .then(data => {
                console.log(data)
                // å‡è®¾è¿”å›æ ¼å¼ { list: [ { cover: '', product_name: '' }, ... ] }
                const list = data.result.list || [];
                const galleryList = document.getElementById('galleryList');
                galleryList.innerHTML = '';
                list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    div.innerHTML = '' +
                        '<img src="' + item.cover + '" alt="' + item.product_name + '">' +
                        '<div class="gallery-item-title">' + item.product_name + '</div>' +
                        '';
                    galleryList.appendChild(div);
                });
            })
            .catch(err => {
                document.getElementById('galleryList').innerHTML = '<div style="color:#f66">å›¾ä¾‹æ•°æ®åŠ è½½å¤±è´¥</div>';
            });
    });

    // æ•°æ®æ€»è§ˆå¡ç‰‡åŒºæ•°æ®åŠ¨æ€è·å–
    document.addEventListener('DOMContentLoaded', function () {
        // ç”¨æˆ·æ€»æ•°
        fetch(baseUrl + '/api/customized_products/count')
            .then(res => res.json())
            .then(data => {
                document.getElementById('userCount').textContent = data.result;
            })
            .catch(() => {
                document.getElementById('userCount').textContent = '-';
            });
        // ç¾é£Ÿä¿¡æ¯æ€»æ•°
        fetch(baseUrl + '/api/customized_products/sum?field=praise_len')
            .then(res => res.json())
            .then(data => {
                document.getElementById('foodSum').textContent = data.result;
            })
            .catch(() => {
                document.getElementById('foodSum').textContent = '-';
            });
        // è¯„åˆ†é¢„æµ‹æ€»æ•°ï¼ˆå¦‚éœ€åŒºåˆ†æ¥å£å¯è¡¥å……ï¼‰
        fetch(baseUrl + '/api/customized_products/count')
            .then(res => res.json())
            .then(data => {
                document.getElementById('predictCount').textContent = data.result;
            })
            .catch(() => {
                document.getElementById('predictCount').textContent = '-';
            });
    });

    // ç”¨æˆ·åˆ—è¡¨ç¼“å­˜
    let userListCache = [];

    // è·å–ç”¨æˆ·åˆ—è¡¨å¹¶ç¼“å­˜
    function fetchAndCacheUserList() {
        return fetch(baseUrl + '/api/user/get_list')
            .then(res => res.json())
            .then(data => {
                if (data.result && data.result.list) {
                    userListCache = data.result.list;
                    console.log('ç”¨æˆ·åˆ—è¡¨ç¼“å­˜æˆåŠŸ:', userListCache);
                }
            })
            .catch(err => {
                console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err);
            });
    }

    // é€šè¿‡ user_id è·å– nickname
    function getNicknameByUserId(userId) {
        console.log(userId)
        const user = userListCache.find(u => u.user_id === userId);
        return user ? user.nickname : 'æœªçŸ¥ç”¨æˆ·';
    }

    // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', function () {
        // å…ˆè·å–ç”¨æˆ·åˆ—è¡¨
        fetchAndCacheUserList().then(() => {
            // è·å–å•†å“åˆ—è¡¨
            fetch(baseUrl + '/api/customized_products/get_list?size=6&page=1')
                .then(res => res.json())
                .then(data => {
                    const list = (data.result && data.result.list) ? data.result.list : [];
                    renderDataTable(list);
                })
                .catch(() => {
                    document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="13" style="color:#f66">æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
                });
        });
    });

    // æ•°æ®åˆ—è¡¨åŠ¨æ€æ¸²æŸ“
    function renderDataTable(list) {
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';
        list.forEach(item => {
            const albumImgs = Array.isArray(item.product_album) ? item.product_album.map(url => `<img src="${url}" style="width:32px;height:32px;object-fit:cover;margin-right:2px;">`).join('') : '';
            // ä½¿ç”¨ç¼“å­˜çš„ç”¨æˆ·åˆ—è¡¨è·å–å•†å®¶ç”¨æˆ·æ˜µç§°
            const merchantUsers = item.merchant_users ? getNicknameByUserId(item.merchant_users) : '-';

            tbody.innerHTML += `
                <tr>
                    <td>${item.product_number || '-'}</td>
                    <td>${item.product_name || '-'}</td>
                    <td>${item.classification_name || '-'}</td>
                    <td>${item.cover ? `<img src="${item.cover}" style="width:40px;height:40px;object-fit:cover;">` : '-'}</td>
                    <td>${item.customized_inventory ?? '-'}</td>
                    <td>${item.production_date || '-'}</td>
                    <td>${albumImgs || '-'}</td>
                    `
                + "<td>" + (merchantUsers || '-') + "</td>"
                + `
                    <td>${item.shelf_life || '-'}</td>
                    <td>${item.customized_declaration || '-'}</td>
                    <td>${item.customized_types || '-'}</td>
                    <td>${item.customized_pricing ?? '-'}</td>
                    <td>${item.classification_number || '-'}</td>
                </tr>
            `;
        });
    }
    </script>
</body>
</html>
